---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "ğŸ“š Build & Deploy Documentation"

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
      - 'pyproject.toml'
  pull_request:
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
      - 'pyproject.toml'
  workflow_dispatch:

# Cancel in-progress runs when a new workflow on the same PR is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # Required for gh-pages deployment

jobs:
  build:
    name: "ğŸ”¨ Build Documentation"
    runs-on: ubuntu-latest
    steps:
      # -------------------------------------------------------------
      # 1. Check out the repository
      # -------------------------------------------------------------
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git-based plugins

      # -------------------------------------------------------------
      # 2. Set up Python
      # -------------------------------------------------------------
      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # -------------------------------------------------------------
      # 3. Install dependencies
      # -------------------------------------------------------------
      - name: "ğŸ“¦ Install MkDocs dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material

      # -------------------------------------------------------------
      # 4. Build documentation
      # -------------------------------------------------------------
      - name: "ğŸ”¨ Build MkDocs site"
        run: mkdocs build --verbose

      # -------------------------------------------------------------
      # 5. Upload build artifacts (for PR preview)
      # -------------------------------------------------------------
      - name: "ğŸ“¤ Upload documentation artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: documentation-site
          path: site/
          retention-days: 7

  deploy:
    name: "ğŸš€ Deploy to GitHub Pages"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write

    steps:
      # -------------------------------------------------------------
      # 1. Check out the repository
      # -------------------------------------------------------------
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------------------
      # 2. Set up Python
      # -------------------------------------------------------------
      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # -------------------------------------------------------------
      # 3. Install dependencies
      # -------------------------------------------------------------
      - name: "ğŸ“¦ Install MkDocs dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material

      # -------------------------------------------------------------
      # 4. Configure Git
      # -------------------------------------------------------------
      - name: "âš™ï¸ Configure Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # -------------------------------------------------------------
      # 5. Deploy to GitHub Pages
      # -------------------------------------------------------------
      - name: "ğŸš€ Deploy to GitHub Pages"
        run: mkdocs gh-deploy --force --verbose

  # Optional: Link check job
  link-check:
    name: "ğŸ”— Check Links"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ“¥ Download documentation artifacts"
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: site/

      - name: "ğŸ”— Check links"
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
        continue-on-error: true
