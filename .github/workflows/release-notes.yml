---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "üìù Create GitHub Release"

on:
  push:
    tags:
      - "*"

jobs:
  create-release:
    name: "üìã Generate Release Notes"
    runs-on: ubuntu-latest

    permissions:
      contents: write       # Required for creating releases
      actions: read         # Required for downloading artifacts

    steps:
      # -------------------------------------------------------------
      # 1. Checkout the repository at the tag
      # -------------------------------------------------------------
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # -------------------------------------------------------------
      # 2. Extract version from tag
      # -------------------------------------------------------------
      - name: üè∑Ô∏è Extract version from tag
        id: version
        run: |
          # Get the tag name (e.g., "0.1.5" or "v0.1.5")
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG_NAME" >> "$GITHUB_OUTPUT"

          # Remove 'v' prefix if present
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          echo "üìå Tag: $TAG_NAME"
          echo "üìå Version: $VERSION"

      # -------------------------------------------------------------
      # 3. Extract changelog section for this version
      # -------------------------------------------------------------
      - name: üìù Extract changelog section
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if CHANGELOG.md exists
          if [ ! -f CHANGELOG.md ]; then
            echo "‚ö†Ô∏è CHANGELOG.md not found, using default release notes"
            echo "body=Release $VERSION" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Extract the section for this version using awk
          # This extracts from "## VERSION" to the next "## " line
          CHANGELOG_SECTION=$(awk -v version="$VERSION" '
            /^## / {
              if (found) exit
              if ($0 ~ "^## " version) {
                found=1
                next
              }
            }
            found { print }
          ' CHANGELOG.md)

          # If extraction failed or is empty, use default message
          if [ -z "$CHANGELOG_SECTION" ]; then
            echo "‚ö†Ô∏è Could not extract changelog for version $VERSION"
            CHANGELOG_SECTION="Release $VERSION"
            CHANGELOG_SECTION="${CHANGELOG_SECTION}"$'\n\n'"See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/CHANGELOG.md) for details."
          fi

          # Save to output using heredoc to preserve multi-line content
          {
            echo "body<<EOF"
            echo "$CHANGELOG_SECTION"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Display extracted content
          echo "üìÑ Extracted changelog:"
          echo "$CHANGELOG_SECTION"

      # -------------------------------------------------------------
      # 4. Wait for publish workflow to complete
      # -------------------------------------------------------------
      - name: ‚è≥ Wait for publish workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ steps.version.outputs.tag }}
          check-name: "üì¶ Build & Publish UBI Image"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 20
          allowed-conclusions: success,skipped,neutral

      # -------------------------------------------------------------
      # 5. Download SBOM artifact from publish workflow
      # -------------------------------------------------------------
      - name: üì• Download SBOM artifact
        id: download-sbom
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: publish.yml
          workflow_conclusion: success
          name: ubi-sbom-${{ steps.version.outputs.version }}
          path: ./sbom-artifacts
          github_token: ${{ secrets.GITHUB_TOKEN }}
          check_artifacts: true
          search_artifacts: true
          if_no_artifact_found: warn

      # -------------------------------------------------------------
      # 6. Prepare SBOM files for release
      # -------------------------------------------------------------
      - name: üì¶ Prepare release assets
        id: prepare-assets
        run: |
          SBOM_EXISTS=false

          if [ -d "./sbom-artifacts" ] && [ -f "./sbom-artifacts/ubi-sbom.spdx.json" ]; then
            echo "‚úÖ SBOM artifact found"
            SBOM_EXISTS=true

            # Rename SBOM file to include version
            cp ./sbom-artifacts/ubi-sbom.spdx.json "./ubi-sbom-${{ steps.version.outputs.version }}.spdx.json"
          else
            echo "‚ö†Ô∏è SBOM artifact not found, release will not include SBOM"
          fi

          echo "sbom_exists=$SBOM_EXISTS" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------------
      # 7. Create GitHub Release
      # -------------------------------------------------------------
      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.body }}

            ---

            ## üì¶ Container Image

            Pull the image:
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/ubi:${{ steps.version.outputs.version }}
            ```

            **Available tags:**
            - `ghcr.io/${{ github.repository_owner }}/ubi:${{ steps.version.outputs.version }}` (pinned version)
            - `ghcr.io/${{ github.repository_owner }}/ubi:latest` (latest release)
            - `ghcr.io/${{ github.repository_owner }}/ubi:sha-<commit>` (exact commit SHA)

            ## üîó Links

            - [Full CHANGELOG](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/CHANGELOG.md)
            - [Documentation](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/README.md)
          files: |
            ubi-sbom-*.spdx.json
          draft: false
          prerelease: false
          generate_release_notes: false
          fail_on_unmatched_files: false

      # -------------------------------------------------------------
      # 8. Display release summary
      # -------------------------------------------------------------
      - name: üìä Display release summary
        run: |
          {
            echo "## üìù GitHub Release Created"
            echo ""
            echo "**Version:** ${{ steps.version.outputs.version }}"
            echo "**Tag:** ${{ steps.version.outputs.tag }}"
            echo ""
            echo "### üì¶ Release Contents"
            echo "- ‚úÖ Changelog notes extracted"
            if [ "${{ steps.prepare-assets.outputs.sbom_exists }}" = "true" ]; then
              echo "- ‚úÖ SBOM attached (ubi-sbom-${{ steps.version.outputs.version }}.spdx.json)"
            else
              echo "- ‚ö†Ô∏è SBOM not attached (not yet available)"
            fi
            echo ""
            echo "### üîó View Release"
            echo "[GitHub Release Page](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})"
            echo ""
            echo "### üì• Pull Container Image"
            echo "\`\`\`bash"
            echo "docker pull ghcr.io/${{ github.repository_owner }}/ubi:${{ steps.version.outputs.version }}"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
