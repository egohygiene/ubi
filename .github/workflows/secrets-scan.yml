---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "üîê Secrets Scanning"

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # Required for uploading security findings
  pull-requests: write    # Optional: for commenting on PRs with scan results

jobs:
  detect-secrets:
    name: "üîç Scan for Secrets"
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------
      # 1. Check out the repository
      # -------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      # -------------------------------------------------------------
      # 2. Set up Python environment for detect-secrets
      # -------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # -------------------------------------------------------------
      # 3. Install detect-secrets
      # -------------------------------------------------------------
      - name: üì¶ Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          pip install detect-secrets==1.5.0

      # -------------------------------------------------------------
      # 4. Verify baseline file exists
      # -------------------------------------------------------------
      - name: ‚úÖ Verify baseline exists
        run: |
          if [ ! -f .secrets.baseline ]; then
            echo "‚ùå ERROR: .secrets.baseline file is missing."
            echo "Run 'detect-secrets scan > .secrets.baseline' to generate it."
            exit 1
          fi
          echo "‚úÖ Baseline file found"

      # -------------------------------------------------------------
      # 5. Run detect-secrets scan
      # -------------------------------------------------------------
      - name: üîç Scan for secrets
        id: scan
        run: |
          echo "üìù Scanning repository for secrets..."
          
          # Create a new scan with all plugins enabled
          detect-secrets scan --all-files \
            --force-use-all-plugins \
            --exclude-files 'poetry.lock' \
            --exclude-files 'package-lock.json' \
            --exclude-files '\.git/.*' \
            --exclude-files '\.vscode/.*' \
            > /tmp/new-scan.json
          
          # Compare new scan with baseline to find new secrets
          # Exit code 0 = no new secrets, exit code 1 = new secrets found
          if python3 -c "
          import json, sys
          
          # Load baseline and new scan
          with open('.secrets.baseline', 'r') as f:
              baseline = json.load(f)
          
          with open('/tmp/new-scan.json', 'r') as f:
              new_scan = json.load(f)
          
          # Extract secrets from both
          baseline_secrets = set()
          for file_secrets in baseline.get('results', {}).values():
              for secret in file_secrets:
                  baseline_secrets.add((secret.get('type'), secret.get('hashed_secret')))
          
          new_secrets_found = []
          for filename, file_secrets in new_scan.get('results', {}).items():
              for secret in file_secrets:
                  secret_tuple = (secret.get('type'), secret.get('hashed_secret'))
                  if secret_tuple not in baseline_secrets:
                      new_secrets_found.append({
                          'file': filename,
                          'type': secret.get('type'),
                          'line': secret.get('line_number', 'unknown')
                      })
          
          if new_secrets_found:
              print('‚ùå New secrets detected:')
              for s in new_secrets_found:
                  print(f\"  - {s['file']}:{s['line']} ({s['type']})\")
              with open('/tmp/new-secrets.json', 'w') as f:
                  json.dump(new_secrets_found, f, indent=2)
              sys.exit(1)
          else:
              print('‚úÖ No new secrets detected')
              sys.exit(0)
          "; then
            echo "‚úÖ No new secrets detected"
            echo "secrets_found=false" >> "$GITHUB_OUTPUT"
          else
            echo "‚ùå New secrets detected!"
            echo "secrets_found=true" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------------------------------------
      # 6. Display scan results in summary
      # -------------------------------------------------------------
      - name: üìä Display scan summary
        if: always()
        run: |
          {
            echo "## üîê Secrets Scanning Summary"
            echo ""
            echo "**Scan Status:** ${{ steps.scan.outputs.secrets_found == 'true' && '‚ùå New secrets detected' || '‚úÖ No new secrets detected' }}"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
          
          if [ -f /tmp/new-secrets.json ]; then
            {
              echo "### ‚ö†Ô∏è New Secrets Detected"
              echo ""
              echo "The following potential secrets were found:"
              echo ""
              python3 -c "
          import json
          with open('/tmp/new-secrets.json', 'r') as f:
              secrets = json.load(f)
          for s in secrets:
              print(f\"- **{s['file']}:{s['line']}** - {s['type']}\")
          " >> "$GITHUB_STEP_SUMMARY"
            } >> "$GITHUB_STEP_SUMMARY"
          fi
          
          {
            echo ""
            echo "### Next Steps"
            if [ "${{ steps.scan.outputs.secrets_found }}" = "true" ]; then
              echo ""
              echo "**If these are real secrets:**"
              echo "1. Remove them from the code immediately"
              echo "2. Rotate/revoke the exposed credentials"
              echo "3. Use environment variables or secret management instead"
              echo ""
              echo "**If these are false positives:**"
              echo "1. Update the baseline file:"
              echo "   \`\`\`bash"
              echo "   detect-secrets scan --all-files --force-use-all-plugins > .secrets.baseline"
              echo "   \`\`\`"
              echo "2. Commit the updated \`.secrets.baseline\` file"
            else
              echo "- ‚úÖ All good! No secrets detected in this change."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # -------------------------------------------------------------
      # 7. Upload scan results as artifact
      # -------------------------------------------------------------
      - name: üì¶ Upload scan results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: secrets-scan-results
          path: |
            /tmp/new-scan.json
            /tmp/new-secrets.json
          retention-days: 30
          if-no-files-found: ignore

      # -------------------------------------------------------------
      # 8. Fail if secrets detected
      # -------------------------------------------------------------
      - name: ‚ùå Fail on secret detection
        if: steps.scan.outputs.secrets_found == 'true'
        run: |
          echo "::error::New secrets detected! Please review and remove them before merging."
          echo "See the scan summary above for details."
          exit 1

      # -------------------------------------------------------------
      # 9. Success message
      # -------------------------------------------------------------
      - name: ‚úÖ Scan complete
        if: steps.scan.outputs.secrets_found == 'false'
        run: |
          echo "‚úÖ Secrets scan completed successfully - no new secrets detected"
