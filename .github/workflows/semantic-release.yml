---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "ðŸ¤– Semantic Release"

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  semantic-release:
    name: "ðŸš€ Semantic Release"
    runs-on: ubuntu-latest

    permissions:
      contents: write       # Required for committing changes and creating tags
      issues: write         # Required for commenting on issues
      pull-requests: write  # Required for commenting on PRs
      id-token: write       # Required for OIDC authentication

    steps:
      # -------------------------------------------------------------
      # 1. Checkout repository with full history
      # -------------------------------------------------------------
      - name: ðŸ›Žï¸ Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0              # Required for semantic-release
          persist-credentials: true   # Required for pushing changes

      # -------------------------------------------------------------
      # 2. Set up Node.js
      # -------------------------------------------------------------
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # -------------------------------------------------------------
      # 3. Install dependencies
      # -------------------------------------------------------------
      - name: ðŸ“¦ Install dependencies
        run: npm ci

      # -------------------------------------------------------------
      # 4. Configure Git
      # -------------------------------------------------------------
      - name: ðŸ”§ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # -------------------------------------------------------------
      # 5. Run semantic-release
      # -------------------------------------------------------------
      - name: ðŸš€ Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: npx semantic-release

      # -------------------------------------------------------------
      # 6. Display summary
      # -------------------------------------------------------------
      - name: ðŸ“‹ Display summary
        if: success()
        run: |
          {
            echo "## ðŸ¤– Semantic Release Summary"
            echo ""
            echo "âœ… Semantic release completed successfully!"
            echo ""
            echo "### What happened?"
            echo "- Analyzed commit messages since last release"
            echo "- Determined version bump (if any)"
            echo "- Updated CHANGELOG.md and VERSION file"
            echo "- Created Git tag and GitHub release"
            echo ""
            echo "### Next Steps"
            echo "The ðŸš€ Publish UBI Image workflow will automatically trigger on the new tag to build and publish the image."
            echo ""
            echo "Check the [Releases page](https://github.com/${{ github.repository }}/releases) for details."
          } >> "$GITHUB_STEP_SUMMARY"
