---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "üß™ Unified Container Testing"

# =============================================================================
# MULTI-ARCHITECTURE TESTING NOTE
# =============================================================================
# This workflow tests images on linux/amd64 (GitHub Actions default).
# Multi-architecture images (amd64, arm64) are built in publish.yml.
# ARM64 testing via QEMU emulation is not performed due to:
# - Performance overhead and longer test times
# - Potential emulation compatibility issues
# - Common practice: test on native architecture, build for multiple platforms
# ARM64 images are validated through the multi-platform build process.
# =============================================================================

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master
    tags:
      - "*"  # trigger on any tagged release
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-unified:
    name: "üîç Test UBI - ${{ matrix.variant.name }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        variant:
          - name: "base"
            dockerfile: ".devcontainer/Dockerfile"
            suffix: ""
          - name: "minimal"
            dockerfile: "variants/minimal/Dockerfile"
            suffix: "-minimal"
          - name: "python"
            dockerfile: "variants/python/Dockerfile"
            suffix: "-python"
          - name: "node"
            dockerfile: "variants/node/Dockerfile"
            suffix: "-node"
          - name: "full"
            dockerfile: "variants/full/Dockerfile"
            suffix: "-full"

    steps:
      # -------------------------------------------------------------
      # 1. Check out the repository
      # -------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v6

      # -------------------------------------------------------------
      # 2. Read VERSION file
      # -------------------------------------------------------------
      - name: Read VERSION
        id: version
        run: |
          if [ ! -f VERSION ]; then
            echo "‚ùå ERROR: VERSION file is missing."
            exit 1
          fi

          VERSION_CONTENT=$(tr -d '[:space:]' < VERSION)

          if [ -z "$VERSION_CONTENT" ]; then
            echo "‚ùå ERROR: VERSION file is empty."
            exit 1
          fi

          echo "VERSION=${VERSION_CONTENT}" >> "$GITHUB_ENV"
          echo "version=${VERSION_CONTENT}" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------------
      # 3. Set up Docker Buildx (for efficient image building)
      # -------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------------------------------------
      # 4. Build the UBI Image (without pushing)
      # -------------------------------------------------------------
      - name: üõ†Ô∏è Build UBI Image (${{ matrix.variant.name }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.variant.dockerfile }}
          load: true  # Load image into local Docker for testing
          tags: ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -------------------------------------------------------------
      # 5. Install Goss for container testing
      # -------------------------------------------------------------
      - name: üì¶ Install Goss
        run: |
          echo "Installing Goss..."
          GOSS_VERSION="v0.4.8"

          # Download and install goss
          curl -fsSL https://goss.rocks/install | GOSS_VER=${GOSS_VERSION} sh

          # Download and install dgoss (Docker wrapper for Goss)
          curl -fsSL -o /usr/local/bin/dgoss \
            https://raw.githubusercontent.com/goss-org/goss/${GOSS_VERSION}/extras/dgoss/dgoss
          chmod +rx /usr/local/bin/dgoss

          # Verify installation
          goss --version
          echo "‚úÖ Goss installed successfully"

      # -------------------------------------------------------------
      # 6. Determine Goss File for Variant
      # -------------------------------------------------------------
      - name: üîç Determine Goss File
        id: goss-file
        run: |
          if [ "${{ matrix.variant.name }}" == "base" ]; then
            echo "file=goss.yaml" >> "$GITHUB_OUTPUT"
            echo "path=tests/goss/goss.yaml" >> "$GITHUB_OUTPUT"
          else
            echo "file=goss-${{ matrix.variant.name }}.yaml" >> "$GITHUB_OUTPUT"
            echo "path=tests/goss/goss-${{ matrix.variant.name }}.yaml" >> "$GITHUB_OUTPUT"
          fi

      # -------------------------------------------------------------
      # 7. Run Variant-Specific Goss Tests
      # -------------------------------------------------------------
      - name: üß™ Run Goss Container Tests - ${{ matrix.variant.name }}
        env:
          GOSS_FILES_PATH: tests/goss
          GOSS_FILE: ${{ steps.goss-file.outputs.path }}
        run: |
          echo "Running Goss tests on UBI ${{ matrix.variant.name }} variant..."
          echo "Using Goss file: $GOSS_FILE"

          # Run dgoss tests
          GOSS_FILES_PATH="${GOSS_FILES_PATH}" \
          GOSS_FILE="${GOSS_FILE}" \
          dgoss run ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }}

      # -------------------------------------------------------------
      # 8. Generate Goss Test Report (JSON)
      # -------------------------------------------------------------
      - name: üìä Generate Goss Test Report - ${{ matrix.variant.name }}
        if: always()
        env:
          GOSS_FILES_PATH: tests/goss
          GOSS_FILE: ${{ steps.goss-file.outputs.file }}
        run: |
          echo "Generating Goss test report for ${{ matrix.variant.name }}..."

          # Run goss validate with JSON output
          docker run --rm \
            -v "$(pwd)"/tests/goss:/goss \
            -e GOSS_FILE=/goss/$GOSS_FILE \
            ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} \
            bash -c '
              curl -fsSL https://goss.rocks/install | GOSS_VER=v0.4.8 sh > /dev/null 2>&1
              goss --gossfile /goss/'"$GOSS_FILE"' validate --format json
            ' > goss-report-${{ matrix.variant.name }}.json || true

          if [ -f goss-report-${{ matrix.variant.name }}.json ]; then
            echo "‚úÖ Goss report generated"
            jq '.' < goss-report-${{ matrix.variant.name }}.json || cat goss-report-${{ matrix.variant.name }}.json
          else
            echo "‚ö†Ô∏è Goss report not generated (tests may have passed without report)"
          fi

      # -------------------------------------------------------------
      # 9. Run Sanity Tests - Universal Directory Structure
      # -------------------------------------------------------------
      - name: üß™ Test - Validate Universal Directory Structure
        run: |
          echo "Testing /opt/universal/* directories existence..."
          docker run --rm ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} bash -c '
            set -e
            echo "Checking required directories..."

            REQUIRED_DIRS=(
              "/opt/universal"
              "/opt/universal/bin"
              "/opt/universal/toolbox"
              "/opt/universal/cache"
              "/opt/universal/logs"
              "/opt/universal/config"
              "/opt/universal/lib"
              "/opt/universal/locks"
              "/opt/universal/fonts"
              "/opt/universal/runtime"
              "/opt/universal/apps"
              "/opt/universal/reports"
            )

            for dir in "${REQUIRED_DIRS[@]}"; do
              if [ ! -d "$dir" ]; then
                echo "‚ùå FAIL: Directory $dir does not exist"
                exit 1
              fi
              echo "‚úÖ PASS: $dir exists"
            done

            echo "All required directories exist!"
          '

      # -------------------------------------------------------------
      # 10. Run Sanity Tests - XDG Environment Variables
      # -------------------------------------------------------------
      - name: üß™ Test - Validate XDG Environment Variables
        run: |
          echo "Testing XDG environment variables..."
          docker run --rm ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} bash -c '
            set -e
            echo "Checking XDG environment variables..."

            # Expected values
            EXPECTED_XDG_CONFIG_HOME="/opt/universal/config"
            EXPECTED_XDG_CACHE_HOME="/opt/universal/cache"
            EXPECTED_XDG_DATA_HOME="/opt/universal/toolbox"
            EXPECTED_XDG_STATE_HOME="/opt/universal/runtime"

            # Check XDG_CONFIG_HOME
            if [ "$XDG_CONFIG_HOME" != "$EXPECTED_XDG_CONFIG_HOME" ]; then
              echo "‚ùå FAIL: XDG_CONFIG_HOME is \"$XDG_CONFIG_HOME\", expected \"$EXPECTED_XDG_CONFIG_HOME\""
              exit 1
            fi
            echo "‚úÖ PASS: XDG_CONFIG_HOME=$XDG_CONFIG_HOME"

            # Check XDG_CACHE_HOME
            if [ "$XDG_CACHE_HOME" != "$EXPECTED_XDG_CACHE_HOME" ]; then
              echo "‚ùå FAIL: XDG_CACHE_HOME is \"$XDG_CACHE_HOME\", expected \"$EXPECTED_XDG_CACHE_HOME\""
              exit 1
            fi
            echo "‚úÖ PASS: XDG_CACHE_HOME=$XDG_CACHE_HOME"

            # Check XDG_DATA_HOME
            if [ "$XDG_DATA_HOME" != "$EXPECTED_XDG_DATA_HOME" ]; then
              echo "‚ùå FAIL: XDG_DATA_HOME is \"$XDG_DATA_HOME\", expected \"$EXPECTED_XDG_DATA_HOME\""
              exit 1
            fi
            echo "‚úÖ PASS: XDG_DATA_HOME=$XDG_DATA_HOME"

            # Check XDG_STATE_HOME
            if [ "$XDG_STATE_HOME" != "$EXPECTED_XDG_STATE_HOME" ]; then
              echo "‚ùå FAIL: XDG_STATE_HOME is \"$XDG_STATE_HOME\", expected \"$EXPECTED_XDG_STATE_HOME\""
              exit 1
            fi
            echo "‚úÖ PASS: XDG_STATE_HOME=$XDG_STATE_HOME"

            # Check that XDG variables point to existing directories
            if [ ! -d "$XDG_CONFIG_HOME" ]; then
              echo "‚ùå FAIL: XDG_CONFIG_HOME points to non-existent directory: $XDG_CONFIG_HOME"
              exit 1
            fi
            echo "‚úÖ PASS: XDG_CONFIG_HOME points to existing directory"

            if [ ! -d "$XDG_CACHE_HOME" ]; then
              echo "‚ùå FAIL: XDG_CACHE_HOME points to non-existent directory: $XDG_CACHE_HOME"
              exit 1
            fi
            echo "‚úÖ PASS: XDG_CACHE_HOME points to existing directory"

            if [ ! -d "$XDG_DATA_HOME" ]; then
              echo "‚ùå FAIL: XDG_DATA_HOME points to non-existent directory: $XDG_DATA_HOME"
              exit 1
            fi
            echo "‚úÖ PASS: XDG_DATA_HOME points to existing directory"

            if [ ! -d "$XDG_STATE_HOME" ]; then
              echo "‚ùå FAIL: XDG_STATE_HOME points to non-existent directory: $XDG_STATE_HOME"
              exit 1
            fi
            echo "‚úÖ PASS: XDG_STATE_HOME points to existing directory"

            echo "All XDG environment variables are correctly configured!"
          '

      # -------------------------------------------------------------
      # 11. Run Sanity Tests - Permissions (vscode user)
      # -------------------------------------------------------------
      - name: üß™ Test - Validate Permissions (vscode user)
        run: |
          echo "Testing vscode user write permissions..."
          docker run --rm --user vscode ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} bash -c '
            set -e
            echo "Testing write permissions as vscode user..."

            TEST_DIRS=(
              "/opt/universal/cache"
              "/opt/universal/config"
              "/opt/universal/logs"
              "/opt/universal/runtime"
              "/opt/universal/toolbox"
            )

            for dir in "${TEST_DIRS[@]}"; do
              TEST_FILE="$dir/.test-write-${RANDOM}"
              if ! touch "$TEST_FILE" 2>/dev/null; then
                echo "‚ùå FAIL: vscode user cannot write to $dir"
                exit 1
              fi
              rm -f "$TEST_FILE"
              echo "‚úÖ PASS: vscode user can write to $dir"
            done

            echo "All permission checks passed!"
          '

      # -------------------------------------------------------------
      # 12. Run Sanity Tests - Locale Configuration
      # -------------------------------------------------------------
      - name: üß™ Test - Validate Locale Configuration
        run: |
          echo "Testing locale configuration..."
          docker run --rm ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} bash -c '
            set -e
            echo "Checking locale environment variables..."

            # Expected values
            EXPECTED_LANG="en_US.UTF-8"
            EXPECTED_LC_ALL="en_US.UTF-8"

            # Check LANG
            if [ "$LANG" != "$EXPECTED_LANG" ]; then
              echo "‚ùå FAIL: LANG is \"$LANG\", expected \"$EXPECTED_LANG\""
              exit 1
            fi
            echo "‚úÖ PASS: LANG=$LANG"

            # Check LC_ALL
            if [ "$LC_ALL" != "$EXPECTED_LC_ALL" ]; then
              echo "‚ùå FAIL: LC_ALL is \"$LC_ALL\", expected \"$EXPECTED_LC_ALL\""
              exit 1
            fi
            echo "‚úÖ PASS: LC_ALL=$LC_ALL"

            echo "Locale configuration is correct!"
          '

      # -------------------------------------------------------------
      # 13. Run Sanity Tests - Fundamental Tools
      # -------------------------------------------------------------
      - name: üß™ Test - Validate Fundamental Tools
        run: |
          echo "Testing fundamental tools availability..."
          docker run --rm ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} bash -c '
            set -e
            echo "Checking fundamental tools..."

            REQUIRED_TOOLS=(
              "bash"
              "sh"
              "ls"
              "cat"
              "touch"
              "echo"
              "grep"
              "sed"
              "awk"
              "find"
              "which"
              "whoami"
              "pwd"
              "mkdir"
              "rm"
              "cp"
              "mv"
            )

            for tool in "${REQUIRED_TOOLS[@]}"; do
              if ! command -v "$tool" >/dev/null 2>&1; then
                echo "‚ùå FAIL: Required tool \"$tool\" not found"
                exit 1
              fi
              echo "‚úÖ PASS: $tool is available"
            done

            echo "All fundamental tools are available!"
          '

      # -------------------------------------------------------------
      # 14. Run Sanity Tests - Command Suite Smoke Tests
      # -------------------------------------------------------------
      - name: üß™ Test - Command Suite Smoke Tests
        run: |
          echo "Running command suite smoke tests..."
          docker run --rm --user vscode ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} bash -c '
            set -e
            echo "Running basic command tests..."

            # Test ls
            echo "Testing ls command..."
            ls / > /dev/null
            echo "‚úÖ PASS: ls command works"

            # Test touch and file creation
            echo "Testing touch command..."
            TEST_FILE="/tmp/test-file-${RANDOM}"
            touch "$TEST_FILE"
            if [ ! -f "$TEST_FILE" ]; then
              echo "‚ùå FAIL: touch command did not create file"
              exit 1
            fi
            rm -f "$TEST_FILE"
            echo "‚úÖ PASS: touch command works"

            # Test echo
            echo "Testing echo command..."
            OUTPUT=$(echo "Hello UBI")
            if [ "$OUTPUT" != "Hello UBI" ]; then
              echo "‚ùå FAIL: echo command output mismatch"
              exit 1
            fi
            echo "‚úÖ PASS: echo command works"

            # Test grep
            echo "Testing grep command..."
            echo "test content" | grep "test" > /dev/null
            echo "‚úÖ PASS: grep command works"

            # Test directory creation and navigation
            echo "Testing mkdir and cd commands..."
            TEST_DIR="/tmp/test-dir-${RANDOM}"
            mkdir -p "$TEST_DIR"
            cd "$TEST_DIR"
            if [ "$(pwd)" != "$TEST_DIR" ]; then
              echo "‚ùå FAIL: cd command did not change directory"
              exit 1
            fi
            cd /
            rm -rf "$TEST_DIR"
            echo "‚úÖ PASS: mkdir and cd commands work"

            echo "All command suite smoke tests passed!"
          '

      # -------------------------------------------------------------
      # 15. Run Non-Root User Tests
      # -------------------------------------------------------------
      - name: üß™ Test - Non-Root User Verification
        run: |
          echo "Running non-root user tests as vscode user..."

          # Test that critical CLI tools work as non-root user
          docker run --rm --user vscode ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} bash -c '
            set -e
            echo "Testing as user: $(whoami)"
            echo "User ID: $(id -u)"
            echo "Group ID: $(id -g)"

            # Verify basic commands work
            bash --version > /dev/null
            git --version > /dev/null
            curl --version > /dev/null

            # Verify write permissions to universal directories
            touch /opt/universal/cache/.test && rm /opt/universal/cache/.test
            touch /opt/universal/config/.test && rm /opt/universal/config/.test
            touch /opt/universal/logs/.test && rm /opt/universal/logs/.test

            echo "‚úÖ All non-root user tests passed"
          '

      # -------------------------------------------------------------
      # 16. Run Variant Inheritance Tests
      # -------------------------------------------------------------
      - name: üß™ Test - Variant Inheritance (${{ matrix.variant.name }})
        run: |
          echo "Running variant inheritance tests for ${{ matrix.variant.name }}..."
          
          # Map variant name to test script
          case "${{ matrix.variant.name }}" in
            "base")
              TEST_SCRIPT="tests/integration/test-variant-minimal.sh"
              ;;
            "minimal")
              TEST_SCRIPT="tests/integration/test-variant-minimal.sh"
              ;;
            "python")
              TEST_SCRIPT="tests/integration/test-variant-python.sh"
              ;;
            "node")
              TEST_SCRIPT="tests/integration/test-variant-node.sh"
              ;;
            "full")
              TEST_SCRIPT="tests/integration/test-variant-full.sh"
              ;;
            *)
              echo "‚ö†Ô∏è  No variant test for ${{ matrix.variant.name }}"
              exit 0
              ;;
          esac

          # Run the test inside the container
          docker run --rm \
            -v "$(pwd)/$TEST_SCRIPT:/test-script.sh:ro" \
            ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} \
            bash /test-script.sh

      # -------------------------------------------------------------
      # 17. Run Environment Variable Tests
      # -------------------------------------------------------------
      - name: üß™ Test - Environment Variables
        run: |
          echo "Running environment variable tests..."
          docker run --rm \
            -v "$(pwd)/tests/integration/test-env-vars.sh:/test-env-vars.sh:ro" \
            ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} \
            bash /test-env-vars.sh

      # -------------------------------------------------------------
      # 18. Run Telemetry Opt-Out Tests
      # -------------------------------------------------------------
      - name: üß™ Test - Telemetry Opt-Out
        run: |
          echo "Running telemetry opt-out validation tests..."
          docker run --rm \
            -v "$(pwd)/tests/integration/test-telemetry.sh:/test-telemetry.sh:ro" \
            ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} \
            bash /test-telemetry.sh

      # -------------------------------------------------------------
      # 19. Run Negative Tests (Restrictions)
      # -------------------------------------------------------------
      - name: üß™ Test - Negative Tests (Restrictions)
        run: |
          echo "Running negative tests (restrictions validation)..."
          docker run --rm \
            -v "$(pwd)/tests/negative/test-restrictions.sh:/test-restrictions.sh:ro" \
            ubi:test-${{ steps.version.outputs.version }}${{ matrix.variant.suffix }} \
            bash /test-restrictions.sh

      # -------------------------------------------------------------
      # 20. Generate test summary
      # -------------------------------------------------------------
      - name: üìã Generate Test Summary
        if: always()
        run: |
          {
            echo "## üß™ Unified Container Test Summary"
            echo ""
            echo "**Variant:** ${{ matrix.variant.name }}"
            echo "**Image Version:** ${{ steps.version.outputs.version }}"
            echo "**Test Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            echo "### Test Coverage"
            echo ""
            echo "‚úÖ Variant-Specific Goss Container Tests"
            echo "  - Filesystem structure validation (goss-${{ matrix.variant.name }}.yaml)"
            echo "  - Command availability tests"
            echo "  - Environment variable checks"
            echo "  - User and group validation"
            echo "  - Package verification"
            echo ""
            echo "‚úÖ Universal Directory Structure Tests"
            echo "  - All /opt/universal/* directories exist"
            echo "  - Correct permissions and ownership (vscode user)"
            echo ""
            echo "‚úÖ XDG Base Directory Specification"
            echo "  - XDG_CONFIG_HOME, XDG_CACHE_HOME validated"
            echo "  - XDG_DATA_HOME, XDG_STATE_HOME validated"
            echo "  - All XDG paths resolve to existing directories"
            echo ""
            echo "‚úÖ Permissions Tests"
            echo "  - vscode user write permissions verified"
            echo "  - Critical directories writable"
            echo ""
            echo "‚úÖ Locale Configuration"
            echo "  - LANG and LC_ALL set to en_US.UTF-8"
            echo ""
            echo "‚úÖ Fundamental Tools"
            echo "  - bash, coreutils, git, curl present"
            echo "  - All required CLI tools available"
            echo ""
            echo "‚úÖ Command Suite Smoke Tests"
            echo "  - File operations (touch, ls, rm) working"
            echo "  - Directory operations (mkdir, cd) working"
            echo "  - Text processing (grep, echo) working"
            echo ""
            echo "‚úÖ Non-Root User Tests"
            echo "  - Container starts correctly under vscode user"
            echo "  - Critical CLI tools run without error"
            echo "  - Write permissions verified"
            echo ""
            echo "‚úÖ Variant Inheritance Tests"
            echo "  - Variant-specific toolchain validated"
            echo "  - Language runtime availability checked"
            echo "  - Inheritance from base variant confirmed"
            echo ""
            echo "‚úÖ Environment Variable Tests"
            echo "  - Comprehensive env var validation"
            echo "  - XDG, locale, and universal paths verified"
            echo ""
            echo "‚úÖ Telemetry Opt-Out Tests"
            echo "  - All telemetry disabled flags verified"
            echo "  - Framework-specific opt-out validated"
            echo ""
            echo "‚úÖ Negative Tests (Restrictions)"
            echo "  - Variant isolation validated"
            echo "  - Security restrictions verified"
            echo "  - No build artifacts left behind"
            echo ""
            echo "### Results"
            echo ""
            if [ "${{ matrix.variant.name }}" == "base" ] && [ -f goss-report-${{ matrix.variant.name }}.json ]; then
              SUMMARY=$(jq -r '.summary // empty' < goss-report-${{ matrix.variant.name }}.json 2>/dev/null || echo "")
              if [ -n "$SUMMARY" ]; then
                echo "\`\`\`json"
                echo "$SUMMARY"
                echo "\`\`\`"
              else
                echo "üìä See goss-report-${{ matrix.variant.name }}.json artifact for detailed results"
              fi
            else
              echo "‚úÖ All tests passed successfully! ‚ú®"
            fi
          } > test-summary-${{ matrix.variant.name }}.md

          cat test-summary-${{ matrix.variant.name }}.md >> "$GITHUB_STEP_SUMMARY"

      # -------------------------------------------------------------
      # 21. Upload test artifacts
      # -------------------------------------------------------------
      - name: üì¶ Upload Test Artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-${{ matrix.variant.name }}
          path: |
            goss-report-${{ matrix.variant.name }}.json
            test-summary-${{ matrix.variant.name }}.md
          retention-days: 30

      # -------------------------------------------------------------
      # 22. Check Goss test results for all variants
      # -------------------------------------------------------------
      - name: ‚ùå Check Goss Test Results
        if: always()
        run: |
          if [ -f goss-report-${{ matrix.variant.name }}.json ]; then
            # Check if there are any failures in the JSON report
            FAILURES=$(jq -r '.summary.failed-count // 0' < goss-report-${{ matrix.variant.name }}.json 2>/dev/null || echo "0")
            if [ "$FAILURES" -gt 0 ]; then
              echo "‚ùå Goss tests failed with $FAILURES failure(s)"
              echo "See goss-report-${{ matrix.variant.name }}.json for details"
              exit 1
            fi
          fi
          echo "‚úÖ All tests passed for ${{ matrix.variant.name }} variant"
