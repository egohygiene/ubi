---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "üîí Container Vulnerability Scan"

on:
  pull_request:
    branches:
      - main
      - master
  workflow_run:
    workflows: ["üß™ Unified Container Testing"]
    types:
      - completed
    branches:
      - main
      - master
  schedule:
    # Run weekly vulnerability scans every Monday at 00:00 UTC
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF results to GitHub Security tab
  pull-requests: write    # Optional: for commenting on PRs with scan results

jobs:
  trivy-scan:
    name: "üîç Scan UBI Image for Vulnerabilities"
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded (for workflow_run) or for other trigger types
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      # -------------------------------------------------------------
      # 1. Check out the repository
      # -------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v6

      # -------------------------------------------------------------
      # 2. Read VERSION file
      # -------------------------------------------------------------
      - name: Read VERSION
        id: version
        run: |
          if [ ! -f VERSION ]; then
            echo "‚ùå ERROR: VERSION file is missing."
            exit 1
          fi

          VERSION_CONTENT=$(tr -d '[:space:]' < VERSION)

          if [ -z "$VERSION_CONTENT" ]; then
            echo "‚ùå ERROR: VERSION file is empty."
            exit 1
          fi

          echo "VERSION=${VERSION_CONTENT}" >> "$GITHUB_ENV"
          echo "version=${VERSION_CONTENT}" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------------
      # 3. Set up Docker Buildx (for efficient image building)
      # -------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------------------------------------
      # 4. Build the UBI Image (without pushing)
      # -------------------------------------------------------------
      - name: üõ†Ô∏è Build UBI Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile
          load: true  # Load image into local Docker for scanning
          tags: ubi:local-${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -------------------------------------------------------------
      # 5. Run Trivy vulnerability scanner
      # -------------------------------------------------------------
      - name: üîç Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ubi:local-${{ steps.version.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail the build if vulnerabilities are found

      # -------------------------------------------------------------
      # 6. Upload Trivy results to GitHub Security tab
      # -------------------------------------------------------------
      - name: üì§ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()  # Upload results even if previous step fails
        with:
          sarif_file: 'trivy-results.sarif'

      # -------------------------------------------------------------
      # 7. Generate human-readable vulnerability report
      # -------------------------------------------------------------
      - name: üìã Generate human-readable report
        if: always()
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ubi:local-${{ steps.version.outputs.version }}
          format: 'table'
          output: 'trivy-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      # -------------------------------------------------------------
      # 8. Upload vulnerability report as artifact
      # -------------------------------------------------------------
      - name: üì¶ Upload vulnerability report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: trivy-vulnerability-report
          path: |
            trivy-results.sarif
            trivy-report.txt
          retention-days: 30

      # -------------------------------------------------------------
      # 9. Display summary of findings
      # -------------------------------------------------------------
      - name: üìä Display scan summary
        if: always()
        run: |
          {
            echo "## üîí Trivy Vulnerability Scan Summary"
            echo ""
            echo "**Image:** ubi:local-${{ steps.version.outputs.version }}"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -f trivy-report.txt ]; then
            {
              echo "### Scan Results"
              echo '```'
              cat trivy-report.txt
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚ö†Ô∏è Report file not generated" >> "$GITHUB_STEP_SUMMARY"
          fi

          {
            echo ""
            echo "üì• Download the full report from the workflow artifacts."
          } >> "$GITHUB_STEP_SUMMARY"
